<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M2 Docs - Architecture</title>
  <meta name="description" content="Architecture documentation for M2.">
  <link rel="icon" type="image/png" href="app-icon.png">
  <link rel="apple-touch-icon" href="app-icon.png">
  <link rel="stylesheet" href="styles.css">
  <script src="main.js" defer></script>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html" aria-label="M2 docs home">
      <img class="site-icon" src="app-icon.png" alt="M2 app icon">
      <span>M2 Engineering Docs</span>
    </a>
    <button class="nav-toggle" type="button" data-nav-toggle aria-expanded="false" aria-controls="site-nav">Menu</button>
    <nav id="site-nav" class="top-nav" data-site-nav aria-label="Primary">
      <a href="index.html" data-nav="index.html">Home</a>
      <a href="architecture.html" data-nav="architecture.html">Architecture</a>
      <a href="desktop-catalyst.html" data-nav="desktop-catalyst.html">Desktop Catalyst</a>
      <a href="services-data.html" data-nav="services-data.html">Services & Data</a>
      <a href="build-ci.html" data-nav="build-ci.html">Build & CI</a>
    </nav>
  </header>

  <main class="docs-layout">
    <aside class="toc card">
      <p class="toc-title">On This Page</p>
      <nav>
        <a href="#overview">Overview</a>
        <a href="#targets">Targets</a>
        <a href="#startup">Startup Sequence</a>
        <a href="#navigation">Navigation Model</a>
        <a href="#modules">Module Boundaries</a>
        <a href="#notifications">Notification Contracts</a>
        <a href="#desktop-shell">Desktop Shell</a>
        <a href="#sequence">Runtime Sequence</a>
      </nav>
    </aside>

    <article class="doc-content">
      <section id="overview" class="card section">
        <p class="eyebrow">Architecture</p>
        <h1>System Overview</h1>
        <p>
          M2 is an offline music player focused on local-file playback with a single-process runtime.
          Most implementation lives in Objective-C, with app services in <code>M2Services.*</code>,
          view composition in <code>M2MusicModule.*</code>, and app shell in <code>ViewController.*</code>.
        </p>
      </section>

      <section id="targets" class="card section">
        <h2>Targets</h2>
        <table>
          <thead>
            <tr>
              <th>Target</th>
              <th>Role</th>
              <th>Languages</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>M2</code></td>
              <td>Main app: playback, library, playlists, favorites, desktop shell.</td>
              <td>Objective-C + Swift bridge</td>
            </tr>
            <tr>
              <td><code>M2LiveActivityExtension</code></td>
              <td>Sleep timer Live Activity UI.</td>
              <td>Swift</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="startup" class="card section">
        <h2>Startup Sequence</h2>
        <pre><code>AppDelegate
  -> configure AVAudioSession
  -> initialize Core Data container

SceneDelegate
  -> create UIWindow
  -> preload library/playlists/favorites/analytics/cache
  -> initialize playback manager singleton
  -> show root shell (ViewController)

ViewController
  -> build tabs (Music / Playlists / Favorites)
  -> build desktop sidebar + mini-player for Catalyst
  -> sync shell with playback notifications</code></pre>
      </section>

      <section id="navigation" class="card section">
        <h2>Navigation Model</h2>
        <ul>
          <li><code>ViewController</code> is a <code>UITabBarController</code> root.</li>
          <li>Each tab is wrapped in its own <code>UINavigationController</code>.</li>
          <li>Mobile uses tab bar; Catalyst hides tab bar and drives tab switching from left sidebar.</li>
          <li>Player screen is pushed from track selection or mini-player open action.</li>
        </ul>
      </section>

      <section id="modules" class="card section">
        <h2>Module Boundaries</h2>
        <table>
          <thead>
            <tr>
              <th>File</th>
              <th>Responsibility</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>M2Services.*</code></td>
              <td>Library scanning, metadata caches, playlist/favorites stores, playback core, analytics, sleep timer.</td>
            </tr>
            <tr>
              <td><code>M2MusicModule.*</code></td>
              <td>Feature view controllers, list/grid presentation, desktop-specific feature pages.</td>
            </tr>
            <tr>
              <td><code>ViewController.*</code></td>
              <td>Application shell, desktop sidebar, mini-player, keyboard shortcuts, tab coordination.</td>
            </tr>
            <tr>
              <td><code>M2Cells.*</code></td>
              <td>Reusable track/playlist cells for table and collection contexts.</td>
            </tr>
            <tr>
              <td><code>M2Models.*</code></td>
              <td>Runtime domain models (<code>M2Track</code>, <code>M2Playlist</code>).</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="notifications" class="card section">
        <h2>Notification Contracts</h2>
        <ul class="clean-list">
          <li><code>M2PlaybackStateDidChangeNotification</code>: transport state changed.</li>
          <li><code>M2PlaybackProgressDidChangeNotification</code>: current playback time update.</li>
          <li><code>M2PlaylistsDidChangeNotification</code>: playlist storage mutation.</li>
          <li><code>M2FavoritesDidChangeNotification</code>: favorites mutation.</li>
          <li><code>M2SleepTimerDidChangeNotification</code>: sleep timer state update.</li>
        </ul>
      </section>

      <section id="desktop-shell" class="card section">
        <h2>Desktop Shell Behavior</h2>
        <ul>
          <li>Catalyst shell enforces dark visual style and a fixed left sidebar.</li>
          <li>Mini-player is always present in desktop layout.</li>
          <li>Tab transitions and navigation pushes are configured without animation on desktop feature flows.</li>
          <li>Pinned playlists are managed in sidebar and open directly into playlist details.</li>
        </ul>
      </section>

      <section id="sequence" class="card section">
        <h2>Runtime Sequence: Track Tap</h2>
        <pre><code>User tap on track
  -> controller resolves queue + index
  -> opens player screen (if needed)
  -> playback manager receives playTracks:startIndex:
  -> AVAudioPlayer starts
  -> playback state notification sent
  -> mini-player and active lists refresh</code></pre>
      </section>
    </article>
  </main>

  <footer class="footer">
    <p>Architecture reference.</p>
    <p id="generated-at"></p>
  </footer>
</body>
</html>
