<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M2 Developer Guide</title>
  <meta name="description" content="Developer guide for the M2 iOS offline music player.">
  <link rel="icon" type="image/png" href="app-icon.png">
  <link rel="apple-touch-icon" href="app-icon.png">
  <link rel="stylesheet" href="styles.css">
  <script src="main.js" defer></script>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html" aria-label="M2 docs home">
      <img class="site-icon" src="app-icon.png" alt="M2 app icon">
      <span>M2 Docs</span>
    </a>
    <nav class="top-nav" aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="user-guide.html">User Guide</a>
      <a href="developer-guide.html" class="active-link">Developer Guide</a>
    </nav>
  </header>

  <main class="layout">
    <aside class="toc card">
      <p class="toc-title">Contents</p>
      <nav>
        <a href="#overview">Overview</a>
        <a href="#targets">Targets</a>
        <a href="#boot-flow">Boot Flow</a>
        <a href="#ui-architecture">UI Architecture</a>
        <a href="#service-layer">Service Layer</a>
        <a href="#playback-engine">Playback Engine</a>
        <a href="#smart-logic">Smart Logic</a>
        <a href="#persistence">Persistence</a>
        <a href="#notifications">Notifications</a>
        <a href="#live-activity">Live Activity</a>
        <a href="#ci">CI</a>
        <a href="#dev-commands">Dev Commands</a>
        <a href="#tree">Project Tree</a>
      </nav>
    </aside>

    <article class="content">
      <section id="overview" class="card section">
        <h1>Developer Guide</h1>
        <p>
          M2 is an iOS offline player with Objective-C app code, a Swift bridge for Live Activity,
          and a Swift Widget extension for lock screen / dynamic island timer UI.
        </p>
        <p>
          Main repository paths: `M2/`, `M2LiveActivityExtension/`, `.github/workflows/`, `docs/`.
        </p>
      </section>

      <section id="targets" class="card section">
        <h2>Targets</h2>
        <table>
          <thead>
            <tr>
              <th>Target</th>
              <th>Language</th>
              <th>Deployment</th>
              <th>Main Role</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>`M2`</td>
              <td>Objective-C + Swift</td>
              <td>iOS 18.2</td>
              <td>Main app, playback core, UI, services</td>
            </tr>
            <tr>
              <td>`M2LiveActivityExtension`</td>
              <td>Swift</td>
              <td>iOS 16.1</td>
              <td>Sleep timer Live Activity widget</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="boot-flow" class="card section">
        <h2>Boot Flow</h2>
        <pre><code>AppDelegate
  - beginReceivingRemoteControlEvents
  - configure AVAudioSessionCategoryPlayback
  - setup Core Data NSPersistentContainer (M2)

SceneDelegate
  - create UIWindow
  - set M2BootViewController as root
  - preload library/playlists/favorites/analytics/covers
  - initialize playback manager singleton
  - transition to ViewController (tab bar)</code></pre>
      </section>

      <section id="ui-architecture" class="card section">
        <h2>UI Architecture</h2>
        <ul>
          <li>`ViewController`: root `UITabBarController`, custom tab look, mini-player, open player flow.</li>
          <li>`M2MusicModule.m`: contains all major view controllers for Music/Playlists/Favorites/Player/playlist flows.</li>
          <li>`M2Cells.*`: reusable table/grid cells for tracks and playlists.</li>
          <li>Search controllers are attached dynamically based on pull distance and current state.</li>
          <li>Most view controllers react to domain notifications and refresh in place.</li>
        </ul>
      </section>

      <section id="service-layer" class="card section">
        <h2>Service Layer (`M2Services.*`)</h2>
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Responsibilities</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>`M2LibraryManager`</td>
              <td>Scan disk, metadata extraction, artwork extraction, cache metadata/artwork, track lookup and deletion.</td>
            </tr>
            <tr>
              <td>`M2PlaylistStore`</td>
              <td>Playlist CRUD, migration/repair, cover management, backup JSON, collage cover generation.</td>
            </tr>
            <tr>
              <td>`M2FavoritesStore`</td>
              <td>Favorite IDs with canonical normalization and deduplication.</td>
            </tr>
            <tr>
              <td>`M2TrackAnalyticsStore`</td>
              <td>Play/skip counters in Core Data and affinity scoring/sorting.</td>
            </tr>
            <tr>
              <td>`M2PlaybackManager`</td>
              <td>Queue, AVAudioPlayer lifecycle, repeat/shuffle, remote commands, now playing info, notifications.</td>
            </tr>
            <tr>
              <td>`M2SleepTimerManager`</td>
              <td>Timer scheduling/cancel, remaining time, playback pause on fire, Live Activity sync.</td>
            </tr>
            <tr>
              <td>`M2ArtworkAccentColorService`</td>
              <td>Extract dominant artwork accent color used for adaptive UI tinting.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="playback-engine" class="card section">
        <h2>Playback Engine Details</h2>

        <h3>Queue and Navigation</h3>
        <ul>
          <li>`playTracks:startIndex:` sets queue and index.</li>
          <li>`playNext` and `playPrevious` use repeat/shuffle state and queue boundaries.</li>
          <li>Shuffle uses `shuffleBag` and `shuffleHistory` to support forward/back navigation.</li>
        </ul>

        <h3>State and Progress</h3>
        <ul>
          <li>Progress timer updates every 0.4s.</li>
          <li>State changes post `M2PlaybackStateDidChangeNotification`.</li>
          <li>Progress changes post `M2PlaybackProgressDidChangeNotification`.</li>
        </ul>

        <h3>Remote Commands</h3>
        <ul>
          <li>Configured through `MPRemoteCommandCenter`.</li>
          <li>Supports play/pause/toggle/next/previous/change position.</li>
          <li>Command availability updated based on queue and playback state.</li>
        </ul>
      </section>

      <section id="smart-logic" class="card section">
        <h2>Smart Logic</h2>

        <h3>Lovely Songs</h3>
        <ul>
          <li>Special playlist inferred from analytics + favorites.</li>
          <li>Selection rule uses activity count, score thresholds, skip limits, and favorite status.</li>
          <li>Playlist is auto-created, refreshed, and kept near top if it has tracks.</li>
        </ul>

        <h3>Analytics Heuristics</h3>
        <ul>
          <li>Playback manager tracks listen ratio and seek-to-end behavior.</li>
          <li>Counts play on natural finish or high listen ratio.</li>
          <li>Counts skip on very early abandonment.</li>
        </ul>
      </section>

      <section id="persistence" class="card section">
        <h2>Persistence</h2>

        <h3>Model Layer</h3>
        <ul>
          <li>`M2Track`: runtime model for local file metadata and artwork.</li>
          <li>`M2Playlist`: serializable playlist model with dictionary conversion helpers.</li>
        </ul>

        <h3>Core Data</h3>
        <table>
          <thead>
            <tr>
              <th>Entity</th>
              <th>Fields</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>`TrackAnalytics`</td>
              <td>`trackID`, `playCount`, `skipCount`, `updatedAt`</td>
            </tr>
          </tbody>
        </table>

        <h3>Files / Keys</h3>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Storage</th>
              <th>Path or Key</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Music files</td>
              <td>Documents</td>
              <td>`M2/`</td>
            </tr>
            <tr>
              <td>Playlists</td>
              <td>NSUserDefaults</td>
              <td>`m2_playlists_v2`</td>
            </tr>
            <tr>
              <td>Playlists backup</td>
              <td>Application Support</td>
              <td>`m2_playlists_backup_v1.json`</td>
            </tr>
            <tr>
              <td>Favorites</td>
              <td>NSUserDefaults</td>
              <td>`m2_favorites_v1`</td>
            </tr>
            <tr>
              <td>Track metadata cache</td>
              <td>Application Support</td>
              <td>`TrackMetadataCache/track_metadata_cache_v1.json`</td>
            </tr>
            <tr>
              <td>Artwork cache</td>
              <td>Application Support</td>
              <td>`TrackMetadataCache/Artwork/*.jpg`</td>
            </tr>
            <tr>
              <td>Playlist covers</td>
              <td>Documents</td>
              <td>`PlaylistCovers/`</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="notifications" class="card section">
        <h2>Notifications</h2>
        <ul>
          <li>`M2PlaybackStateDidChangeNotification`</li>
          <li>`M2PlaybackProgressDidChangeNotification`</li>
          <li>`M2PlaylistsDidChangeNotification`</li>
          <li>`M2FavoritesDidChangeNotification`</li>
          <li>`M2SleepTimerDidChangeNotification`</li>
        </ul>
        <p>
          Controllers subscribe to these notifications to keep UI synchronized without custom polling loops.
        </p>
      </section>

      <section id="live-activity" class="card section">
        <h2>Live Activity</h2>
        <ul>
          <li>Main app bridge: `M2SleepTimerLiveActivityBridge.swift` (`@objc` entry points).</li>
          <li>Extension widget: `M2SleepTimerLiveActivity.swift`.</li>
          <li>Bundle entry: `M2LiveActivityWidgetBundle.swift`.</li>
          <li>Enabled by extension Info.plist `NSSupportsLiveActivities`.</li>
        </ul>
      </section>

      <section id="ci" class="card section">
        <h2>CI</h2>
        <table>
          <thead>
            <tr>
              <th>Workflow</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>`.github/workflows/ios-ci.yml`</td>
              <td>Build app target and extension target separately on simulator.</td>
            </tr>
            <tr>
              <td>`.github/workflows/ios.yml`</td>
              <td>Starter workflow: scheme detection, build-for-testing, test-without-building.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="dev-commands" class="card section">
        <h2>Dev Commands</h2>
        <div class="command-grid">
          <div class="command-box">
            <p>Open project</p>
            <code>open M2.xcodeproj</code>
            <button class="copy-btn" data-copy="open M2.xcodeproj">Copy</button>
          </div>
          <div class="command-box">
            <p>Build app target</p>
            <code>xcodebuild -project "M2.xcodeproj" -scheme "M2" -configuration Debug -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO clean build</code>
            <button class="copy-btn" data-copy="xcodebuild -project \"M2.xcodeproj\" -scheme \"M2\" -configuration Debug -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO clean build">Copy</button>
          </div>
          <div class="command-box">
            <p>Build extension target</p>
            <code>xcodebuild -project "M2.xcodeproj" -scheme "M2LiveActivityExtension" -configuration Debug -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO clean build</code>
            <button class="copy-btn" data-copy="xcodebuild -project \"M2.xcodeproj\" -scheme \"M2LiveActivityExtension\" -configuration Debug -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO clean build">Copy</button>
          </div>
        </div>
      </section>

      <section id="tree" class="card section">
        <h2>Project Tree</h2>
        <pre><code>M2/
  AppDelegate.*
  SceneDelegate.*
  ViewController.*
  M2MusicModule.*
  M2Services.*
  M2Models.*
  M2Cells.*
  M2SleepTimerLiveActivityBridge.swift
  M2.xcdatamodeld/

M2LiveActivityExtension/
  M2SleepTimerLiveActivity.swift
  M2LiveActivityWidgetBundle.swift
  Info.plist

.github/workflows/
  ios-ci.yml
  ios.yml

docs/
  app-icon.png
  index.html
  user-guide.html
  developer-guide.html
  styles.css
  main.js</code></pre>
      </section>
    </article>
  </main>

  <footer class="footer">
    <p>Developer-facing documentation for M2.</p>
    <p id="generated-at"></p>
  </footer>
</body>
</html>
