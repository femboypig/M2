<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>M2 Docs - Services & Data</title>
  <meta name="description" content="M2 service layer and data contracts.">
  <link rel="icon" type="image/png" href="app-icon.png">
  <link rel="apple-touch-icon" href="app-icon.png">
  <link rel="stylesheet" href="styles.css">
  <script src="main.js" defer></script>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html" aria-label="M2 docs home">
      <img class="site-icon" src="app-icon.png" alt="M2 app icon">
      <span>M2 Engineering Docs</span>
    </a>
    <button class="nav-toggle" type="button" data-nav-toggle aria-expanded="false" aria-controls="site-nav">Menu</button>
    <nav id="site-nav" class="top-nav" data-site-nav aria-label="Primary">
      <a href="index.html" data-nav="index.html">Home</a>
      <a href="architecture.html" data-nav="architecture.html">Architecture</a>
      <a href="services-data.html" data-nav="services-data.html">Services & Data</a>
      <a href="build-ci.html" data-nav="build-ci.html">Build & CI</a>
    </nav>
  </header>

  <main class="docs-layout">
    <aside class="toc card">
      <p class="toc-title">On This Page</p>
      <nav>
        <a href="#services">Core Services</a>
        <a href="#playback">Playback Engine</a>
        <a href="#playlists">Playlist Store</a>
        <a href="#favorites">Favorites</a>
        <a href="#analytics">Analytics</a>
        <a href="#storage">Storage Keys</a>
        <a href="#notifications">Notifications</a>
        <a href="#caches">Cache Strategy</a>
      </nav>
    </aside>

    <article class="doc-content">
      <section id="services" class="card section">
        <p class="eyebrow">Domain Layer</p>
        <h1>Core Services</h1>
        <table>
          <thead>
            <tr>
              <th>Service</th>
              <th>Responsibilities</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>M2LibraryManager</code></td>
              <td>Track scanning, metadata extraction, artwork extraction, file deletion, cache warmup.</td>
            </tr>
            <tr>
              <td><code>M2PlaylistStore</code></td>
              <td>Playlist CRUD, custom covers, backup JSON, cover composition, migration safety.</td>
            </tr>
            <tr>
              <td><code>M2FavoritesStore</code></td>
              <td>Favorite ID set management and library projection.</td>
            </tr>
            <tr>
              <td><code>M2TrackAnalyticsStore</code></td>
              <td>Play/skip counters and affinity scoring pipeline.</td>
            </tr>
            <tr>
              <td><code>M2PlaybackManager</code></td>
              <td>Queue execution, repeat/shuffle, seek, now-playing metadata, remote command center.</td>
            </tr>
            <tr>
              <td><code>M2SleepTimerManager</code></td>
              <td>Timer lifecycle, remaining time updates, playback stop trigger, live activity sync.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="playback" class="card section">
        <h2>Playback Engine Contracts</h2>
        <ul>
          <li><code>playTracks:startIndex:</code> defines queue and active index atomically.</li>
          <li><code>playNext</code>/<code>playPrevious</code> respect repeat mode and shuffle history.</li>
          <li>Progress notifications are emitted continuously while active.</li>
          <li>Remote transport commands are enabled/disabled from queue state.</li>
        </ul>
      </section>

      <section id="playlists" class="card section">
        <h2>Playlist Store Rules</h2>
        <ul>
          <li>Playlist identifiers are stable and persisted.</li>
          <li>Cover resolution order: custom cover -> collage from tracks -> placeholder artwork.</li>
          <li>"Lovely songs" playlist is auto-maintained from analytics heuristics.</li>
        </ul>
      </section>

      <section id="favorites" class="card section">
        <h2>Favorites Rules</h2>
        <ul>
          <li>Favorites are persisted as normalized track identifiers.</li>
          <li>Favorites view resolves current library snapshot each reload.</li>
        </ul>
      </section>

      <section id="analytics" class="card section">
        <h2>Analytics Heuristics</h2>
        <pre><code>Inputs:
  playCount, skipCount, listen ratio, seek-to-end behavior

Outputs:
  score (affinity)
  sorted track ranking
  lovely-playlist eligibility decision</code></pre>
      </section>

      <section id="storage" class="card section">
        <h2>Storage Keys & Paths</h2>
        <table>
          <thead>
            <tr>
              <th>Resource</th>
              <th>Storage</th>
              <th>Key / Path</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Playlists</td>
              <td>NSUserDefaults</td>
              <td><code>m2_playlists_v2</code></td>
            </tr>
            <tr>
              <td>Favorites</td>
              <td>NSUserDefaults</td>
              <td><code>m2_favorites_v1</code></td>
            </tr>
            <tr>
              <td>NSUserDefaults</td>
            </tr>
            <tr>
              <td>Playlists backup</td>
              <td>Application Support</td>
              <td><code>m2_playlists_backup_v1.json</code></td>
            </tr>
            <tr>
              <td>Track metadata cache</td>
              <td>Application Support</td>
              <td><code>TrackMetadataCache/track_metadata_cache_v1.json</code></td>
            </tr>
            <tr>
              <td>Artwork cache</td>
              <td>Application Support</td>
              <td><code>TrackMetadataCache/Artwork/*.jpg</code></td>
            </tr>
            <tr>
              <td>Playlist covers</td>
              <td>Documents</td>
              <td><code>PlaylistCovers/</code></td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="notifications" class="card section">
        <h2>Notification Bus</h2>
        <ul class="clean-list">
          <li><code>M2PlaybackStateDidChangeNotification</code></li>
          <li><code>M2PlaybackProgressDidChangeNotification</code></li>
          <li><code>M2PlaylistsDidChangeNotification</code></li>
          <li><code>M2FavoritesDidChangeNotification</code></li>
          <li><code>M2SleepTimerDidChangeNotification</code></li>
        </ul>
      </section>

      <section id="caches" class="card section">
        <h2>Cache Strategy</h2>
        <ul>
          <li>Track metadata and artwork are persisted to reduce startup IO.</li>
          <li>Playlist cover cache is invalidated on cover mutation.</li>
          <li>Warmup in scene startup preloads hot objects for first-render speed.</li>
        </ul>
      </section>
    </article>
  </main>

  <footer class="footer">
    <p>Services and data contracts.</p>
    <p id="generated-at"></p>
  </footer>
</body>
</html>
